language: go

go:
  - 1.8

env:
  global:
  - DESCRIPTOR="descriptor.json"
  - MANIFEST="manifest.yml"

install:
  - ln -sf `pwd` $GOPATH/src/crb
  - curl -o swagger -L'#' https://github.com/go-swagger/go-swagger/releases/download/0.8.0/swagger_$(echo `uname`|tr '[:upper:]' '[:lower:]')_amd64
  - chmod +x swagger
  - cd $GOPATH/src/crb
  - ./swagger generate server -f swagger.yaml -A crb
  - go get github.com/tools/godep
  - godep version
  - godep restore
  - ./swagger generate server -f swagger.yaml -A crb
  
script:
  - ls $GOPATH/src/
  - go install ./...
  - ls -la
  - go test ./...
  - cd cmd/crb-server/
  - go build
  - ls -la
  - cd $GOPATH/src/crb/
  - cat descriptor.json
  - cat manifest.yml
  
deploy:  
  skip_cleanup: true
  provider: bintray
  user: yqian30
  key: $BINTRAY_DEPLOY_KEY
  file: descriptor.json
  on:
    all_branches: true
    
after_deploy:
  - VERSION_IN_DISCRIPTOR=$(grep -A2 '"name"' descriptor.json | grep -o "[0-9]*\.[0-9]*")
  - echo $VERSION_IN_DISCRIPTOR
  - NEW_VERSION=$(echo "$VERSION_IN_DISCRIPTOR+0.1" | bc | awk '{printf "%.1f", $0}')
  - echo $NEW_VERSION
  - MATCH='s/\"name\"\:\s*\"'$VERSION_IN_DISCRIPTOR'\"/\"name\"\:\"'$NEW_VERSION'\"/'
  - sed -i $MATCH $DESCRIPTOR
  - MATCH='s/crb-server-'$VERSION_IN_DISCRIPTOR'/crb-server-'$NEW_VERSION'/'
  - sed -i $MATCH $DESCRIPTOR
  - MATCH='s/manifest-'$VERSION_IN_DISCRIPTOR'\.yml/manifest-'$NEW_VERSION'\.yml/'
  - sed -i $MATCH $DESCRIPTOR
  - cat $DESCRIPTOR
  - VERSION_IN_MANIFEST=$(cat $MANIFEST | grep 'CRB_VERSION' | awk {'print $2'})
  - echo $VERSION_IN_MANIFEST
  - MATCH='s/'$VERSION_IN_MANIFEST'/'$NEW_VERSION'/'
  - sed -i $MATCH $MANIFEST
  - cat $MANIFEST
  - git checkout -B $TRAVIS_BRANCH
  - git add $DESCRIPTOR
  - git add $MANIFEST
  - git commit -m "[ci skip] Updated descriptor and manifest files with new version $NEW_VERSION."
  - git push origin $TRAVIS_BRANCH
  
